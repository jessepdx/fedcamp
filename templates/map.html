{% extends "base.html" %}
{% block title %}RV Camping Finder{% endblock %}

{% block head %}
<style>
    #state-map {
        height: 75vh;
        min-height: 300px;
        border-radius: 8px;
        border: 1px solid #ddd;
    }
    .map-status {
        background: white;
        padding: 8px 14px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        font-size: 0.9rem;
        min-width: 180px;
    }
    .map-status strong {
        display: block;
        margin-bottom: 2px;
    }
    .map-status small {
        color: #666;
    }
    .map-legend {
        background: white;
        padding: 8px 12px;
        border-radius: 6px;
        box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        font-size: 0.8rem;
        line-height: 1.6;
    }
    .map-legend i {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 5px;
        vertical-align: middle;
        border: 2px solid #fff;
        box-shadow: 0 0 0 1px rgba(0,0,0,0.2);
    }
</style>
{% endblock %}

{% block content %}
<hgroup>
    <h1>RV Camping Finder</h1>
    <p>Pan and zoom to explore campgrounds. Use filters to narrow results.</p>
</hgroup>

<div id="state-map"></div>

<div class="map-filters-bar">
    <div class="mf-group">
        <span class="mf-label">Type</span>
        <div id="mf-type-group" class="mf-toggle-group">
            <button class="mf-toggle" data-key="DEVELOPED">Developed</button>
            <button class="mf-toggle" data-key="PRIMITIVE">Primitive</button>
            <button class="mf-toggle" data-key="DISPERSED">Dispersed</button>
        </div>
    </div>
    <div class="mf-group">
        <span class="mf-label">Agency</span>
        <div id="mf-agency" class="mf-check-row">
            <label><input type="checkbox" value="FS"> FS</label>
            <label><input type="checkbox" value="BLM"> BLM</label>
            <label><input type="checkbox" value="USACE"> USACE</label>
            <label><input type="checkbox" value="NPS"> NPS</label>
            <label><input type="checkbox" value="BOR"> BOR</label>
            <label><input type="checkbox" value="FWS"> FWS</label>
        </div>
    </div>
    <div class="mf-group">
        <span class="mf-label">Road</span>
        <div id="mf-road" class="mf-check-row">
            <label><input type="checkbox" value="PAVED"> Paved</label>
            <label><input type="checkbox" value="GRAVEL"> Gravel</label>
            <label><input type="checkbox" value="DIRT"> Dirt</label>
            <label><input type="checkbox" value="HIGH_CLEARANCE"> High Clr</label>
            <label><input type="checkbox" value="4WD_REQUIRED"> 4WD</label>
        </div>
    </div>
    <div class="mf-group">
        <span class="mf-label">Hookups</span>
        <div id="mf-hookups" class="mf-check-row">
            <label><input type="checkbox" value="electric"> Electric</label>
            <label><input type="checkbox" value="water"> Water</label>
            <label><input type="checkbox" value="sewer"> Sewer</label>
        </div>
    </div>
    <div class="mf-group">
        <span class="mf-label">Min RV</span>
        <input type="number" id="mf-rv-input" class="mf-rv-input" placeholder="ft" min="0" max="100">
    </div>
    <button id="mf-reset-btn" class="mf-reset-btn" title="Reset filters">&#8634;</button>
</div>
<noscript>
    <p>This page requires JavaScript to display the map. <a href="/search-form">Use the search form instead</a>.</p>
</noscript>
{% endblock %}

{% block scripts %}
<script>
(function() {
    try {

    var map = L.map('state-map', {
        center: [39.5, -98.5],
        zoom: 4,
        minZoom: 3,
        maxZoom: 18,
        preferCanvas: true
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors',
        maxZoom: 18
    }).addTo(map);

    // Status control (top-left)
    var status = L.control({position: 'topleft'});
    status.onAdd = function() {
        this._div = L.DomUtil.create('div', 'map-status');
        this._div.innerHTML = '<strong>Locating you...</strong>';
        return this._div;
    };
    status.update = function(html) {
        this._div.innerHTML = html;
    };
    status.addTo(map);

    // Legend control (bottom-right)
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function() {
        var div = L.DomUtil.create('div', 'map-legend');
        div.innerHTML =
            '<i style="background:#2d7d46"></i>Developed<br>' +
            '<i style="background:#c49f17"></i>Primitive<br>' +
            '<i style="background:#6c5ce7"></i>Dispersed<br>' +
            '<i style="background:#d4782f"></i>Seasonal<br>' +
            '<i style="background:#c0392b"></i>Closed';
        return div;
    };
    legend.addTo(map);

    // ---------------------------------------------------------------
    // Filters (bar below map)
    // ---------------------------------------------------------------
    var filters = {
        camping_types: [],
        agencies: [],
        road_access: [],
        hookups: [],
        min_rv_length: null
    };

    function readFiltersAndReload() {
        filters.camping_types = [];
        document.querySelectorAll('#mf-type-group .mf-toggle.active').forEach(function(b) {
            filters.camping_types.push(b.dataset.key);
        });
        filters.agencies = [];
        document.querySelectorAll('#mf-agency input:checked').forEach(function(c) { filters.agencies.push(c.value); });
        filters.road_access = [];
        document.querySelectorAll('#mf-road input:checked').forEach(function(c) { filters.road_access.push(c.value); });
        filters.hookups = [];
        document.querySelectorAll('#mf-hookups input:checked').forEach(function(c) { filters.hookups.push(c.value); });
        var val = parseInt(document.getElementById('mf-rv-input').value, 10);
        filters.min_rv_length = val > 0 ? val : null;
        loadPins();
    }

    // Camping type toggles
    document.querySelectorAll('#mf-type-group .mf-toggle').forEach(function(btn) {
        btn.onclick = function() {
            btn.classList.toggle('active');
            readFiltersAndReload();
        };
    });

    // Checkbox groups
    ['mf-agency', 'mf-road', 'mf-hookups'].forEach(function(id) {
        document.querySelectorAll('#' + id + ' input').forEach(function(cb) {
            cb.onchange = function() { readFiltersAndReload(); };
        });
    });

    // RV length (debounced)
    var rvDebounce;
    document.getElementById('mf-rv-input').oninput = function() {
        clearTimeout(rvDebounce);
        rvDebounce = setTimeout(readFiltersAndReload, 500);
    };

    // Reset
    document.getElementById('mf-reset-btn').onclick = function() {
        document.querySelectorAll('#mf-type-group .mf-toggle.active').forEach(function(b) { b.classList.remove('active'); });
        document.querySelectorAll('.map-filters-bar input[type=checkbox]').forEach(function(cb) { cb.checked = false; });
        document.getElementById('mf-rv-input').value = '';
        readFiltersAndReload();
    };

    // ---------------------------------------------------------------
    // Pin layer and loading
    // ---------------------------------------------------------------
    var pinLayer = L.layerGroup().addTo(map);
    var loadDebounce;
    var currentRequest = null;

    function campingColor(type, seasonal) {
        if (seasonal === 'PERMANENTLY_CLOSED' || seasonal === 'TEMPORARILY_CLOSED')
            return '#c0392b';
        if (seasonal === 'WINTER_CLOSURE' || seasonal === 'SEASONAL_CLOSURE')
            return '#d4782f';
        var colors = { 'DEVELOPED': '#2d7d46', 'PRIMITIVE': '#c49f17', 'DISPERSED': '#6c5ce7' };
        return colors[type] || '#95a5a6';
    }

    function escapeHtml(str) {
        if (!str) return '';
        var d = document.createElement('div');
        d.appendChild(document.createTextNode(str));
        return d.innerHTML;
    }

    function buildQuery() {
        var b = map.getBounds();
        var params = 'south=' + b.getSouth().toFixed(4)
            + '&north=' + b.getNorth().toFixed(4)
            + '&west=' + b.getWest().toFixed(4)
            + '&east=' + b.getEast().toFixed(4);
        filters.camping_types.forEach(function(v) { params += '&camping_type=' + v; });
        filters.agencies.forEach(function(v) { params += '&agency=' + v; });
        filters.road_access.forEach(function(v) { params += '&road_access=' + v; });
        filters.hookups.forEach(function(v) { params += '&hookup=' + v; });
        if (filters.min_rv_length) params += '&min_rv_length=' + filters.min_rv_length;
        return params;
    }

    function loadPins() {
        if (currentRequest) { currentRequest.abort(); currentRequest = null; }

        var query = buildQuery();
        status.update('<strong>Loading...</strong>');

        var controller = new AbortController();
        currentRequest = controller;

        fetch('/api/pins?' + query, {signal: controller.signal})
            .then(function(r) { return r.json(); })
            .then(function(pins) {
                currentRequest = null;
                pinLayer.clearLayers();
                pins.forEach(function(p) {
                    var marker = L.circleMarker([p.latitude, p.longitude], {
                        radius: 7,
                        fillColor: campingColor(p.camping_type, p.seasonal_status),
                        color: '#fff',
                        weight: 2,
                        fillOpacity: 0.85,
                        bubblingMouseEvents: false
                    }).addTo(pinLayer);

                    var html = '<strong><a href="/facility/' + p.facility_id + '" target="_blank">'
                        + escapeHtml(p.facility_name) + '</a></strong>';
                    if (p.total_campsites) html += '<br>' + p.total_campsites + ' sites';
                    if (p.org_abbrev) html += ' &middot; ' + p.org_abbrev;
                    if (p.max_rv_length) html += '<br>Max RV: ' + p.max_rv_length + ' ft';
                    if (p.seasonal_status === 'PERMANENTLY_CLOSED') html += '<br><em>Permanently Closed</em>';
                    else if (p.seasonal_status === 'TEMPORARILY_CLOSED') html += '<br><em>Temporarily Closed</em>';
                    else if (p.seasonal_status === 'WINTER_CLOSURE') html += '<br><em>Winter Closure</em>';
                    else if (p.seasonal_status === 'SEASONAL_CLOSURE') html += '<br><em>Seasonal</em>';
                    marker.bindPopup(html);
                    marker.bindTooltip(escapeHtml(p.facility_name));
                });
                status.update('<strong>' + pins.length + ' campgrounds</strong><small>in view</small>');
            })
            .catch(function(err) {
                if (err.name !== 'AbortError') {
                    currentRequest = null;
                    status.update('<strong>Error loading pins</strong>');
                }
            });
    }

    // Debounced load on map move
    map.on('moveend', function() {
        clearTimeout(loadDebounce);
        loadDebounce = setTimeout(loadPins, 300);
    });

    // ---------------------------------------------------------------
    // Geolocation
    // ---------------------------------------------------------------
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(pos) {
            var lat = pos.coords.latitude;
            var lon = pos.coords.longitude;
            L.circleMarker([lat, lon], {
                radius: 10, fillColor: '#3b82f6', color: '#fff',
                weight: 3, fillOpacity: 0.9
            }).addTo(map).bindPopup('You are here').openPopup();
            map.setView([lat, lon], 8);
            // moveend will fire and trigger loadPins
        }, function() {
            // Geolocation failed â€” load pins for default view
            loadPins();
        }, { enableHighAccuracy: false, timeout: 10000, maximumAge: 300000 });
    } else {
        loadPins();
    }

    } catch(e) {
        document.getElementById('state-map').innerHTML =
            '<p style="padding:2rem;text-align:center;">Map failed to load. <a href="/search-form">Use the search form instead</a>.'
            + '<br><small style="color:#999;">' + e.message + '</small></p>';
    }
})();
</script>
{% endblock %}
